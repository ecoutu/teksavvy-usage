<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title>Teksavvy Usage</title>
 <link href="js/bower_components/c3/c3.css" rel="stylesheet" type="text/css" />

 <script src="js/bower_components/d3/d3.min.js" charset="utf-8"></script>
 <script src="js/bower_components/c3/c3.min.js"></script>
 <script src="js/bower_components/jquery/dist/jquery.js"></script>
 <script src="js/bower_components/moment/moment.js"></script>
 <script src="js/bower_components/underscore/underscore.js"></script>
 <script type="text/javascript">

  var chart = null;
  var usage = null;
  $(document).ready(function() {

    var loadData = function(usage) {
      var xAxis = ['x'];

      var onPeakDownload = ['On Peak Download'];
      var onPeakUpload = ['On Peak Upload'];
      var offPeakDownload = ['Off Peak Download'];
      var offPeakUpload = ['Off Peak Upload'];

      _.each(usage, function(us) {
        var uDate = moment(us.Date);

        // need to change date format - c3's date parsing sucks
        xAxis.push(moment(us.Date).format('YYYY-MM-DD'));
        onPeakDownload.push(us.OnPeakDownload);
        onPeakUpload.push(us.OnPeakUpload);
        offPeakDownload.push(us.OffPeakDownload)
        offPeakUpload.push(us.OffPeakUpload);
      });
      chart.load({
        columns: [
          xAxis,
          onPeakDownload,
          onPeakUpload,
          offPeakDownload,
          offPeakUpload
        ]
      });
    };

    var submit = function() {
      var apiKey = $('#api-key').val();
      $.getJSON('usage/' + apiKey, function(res) {
        usage = res;

        var minDate = _.min(usage, function(us) { return moment(us.Date); });
        var maxDate = _.max(usage, function(us) { return moment(us.Date); });

        $('#start-date-filter').val(moment(minDate.Date).format('YYYY-MM-DD'));
        $('#end-date-filter').val(moment(maxDate.Date).format('YYYY-MM-DD'));

        chart = c3.generate({
          bindto: '#chart',
          data: {
            x: 'x',
            columns: []
          },
          axis: {
            x: {
              type: 'timeseries',
              tick: {
                format: '%Y-%m-%d'
              }
            },
            y: {
              label: {
                text: 'Usage (GB)',
                position: 'outer-middle'
              }
            }
          }
        });
        loadData(usage);
        $('#filter-menu').show();
      });
    };

    $('#api-key').focus();
    $('#submit').click(submit);

    $('#api-key').keypress(function(e) {
      if (e.which === 13) {
        $('#submit').click();
      }
    });

    $('#start-date-filter, #end-date-filter').change(function() {
      var startDate = $('#start-date-filter').val();
      var endDate = $('#end-date-filter').val();

      if (startDate) {
        startDate = moment(startDate);
      }
      if (endDate) {
        endDate = moment(endDate);
      }

      var filteredUsage = _.filter(usage, function(us) {
        var usDate = moment(us.Date);
        if (startDate && usDate < startDate) {
          return false;
        } else if (endDate && usDate > endDate) {
          return false;
        } else {
          return true;
        }
      });
      loadData(filteredUsage);
    });
   });
</script>
<style>
#top-bar {
  padding-bottom: 20px;
}

#filter-menu {
  display:none;
  padding-left: 50px;
}

#api-key {
  width: 25em;
}

label, input.labeled {
  float: left;
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size: 13px;
}

label {
  width: 5em;
  padding-top: 3px;
  color: #404040;
  line-height: 18px;
  text-align: right;
  padding-right: 10px;
}

.input-line {
  padding: 5px;
  clear: left;
}

#submit {
  margin-left: 10px;
}
</style>
 </head>
<body>
<div id="top-bar">
  <label for="api-key">API Key</label><input type="text" id="api-key" class="labeled"></input> <input type="button" value="Submit" id="submit"></input>
</div>
<div id="chart"></div>
<div id="filter-menu">
  <div class="input-line">
    <label for="start-date-filter">Start Date</label>
    <input type="date" id="start-date-filter" class="labeled"></input>
  </div>
  <div class="input-line">
    <label for="end-date-filter">End Date</label>
    <input type="date" id="end-date-filter" class="labeled"></input>
  </div>
</div>
</body>
</html>
