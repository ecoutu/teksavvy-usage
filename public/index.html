<!DOCTYPE html>
<html>
<head lang="en">
  <meta charset="UTF-8">
  <title></title>
<!--
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,300,600' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="./css/styles.css"/>

  <script src="js/bower_components/requirejs/require.js"></script>
  <script src="js/config.js"></script>
  <script src="js/main.js"></script>
 -->
 <link href="js/bower_components/c3/c3.css" rel="stylesheet" type="text/css" />

 <script src="js/bower_components/d3/d3.min.js" charset="utf-8"></script>
 <script src="js/bower_components/c3/c3.min.js"></script>
 <script src="js/bower_components/jquery/dist/jquery.js"></script>
 <script src="js/bower_components/moment/moment.js"></script>
 <script src="js/bower_components/underscore/underscore.js"></script>
 <script type="text/javascript">
  var chart = null;
  $(document).ready(function() {
    var usage = null;

    var loadData = function(usage) {
      var xAxis = ['x'];

      var onPeakDownload = ['On Peak Download'];
      var onPeakUpload = ['On Peak Upload'];
      var offPeakDownload = ['Off Peak Download'];
      var offPeakUpload = ['Off Peak Upload'];

      _.each(usage, function(us) {
        var uDate = moment(us.Date);

        // need to change date format - c3's date parsing sucks
        xAxis.push(moment(us.Date).format('YYYY-MM-DD'));
        onPeakDownload.push(us.OnPeakDownload);
        onPeakUpload.push(us.OnPeakUpload);
        offPeakDownload.push(us.OffPeakDownload)
        offPeakUpload.push(us.OffPeakUpload);
      });
      chart.load({
        columns: [
          xAxis,
          onPeakDownload,
          onPeakUpload,
          offPeakDownload,
          offPeakUpload
        ]
      });
    };

    $('#submit').click(function() {
      var apiKey = $('#api-key').val();
      $.getJSON('usage/'+apiKey, function(res) {
        usage = res;

        chart = c3.generate({
          bindto: '#chart',
          data: {
            x: 'x',
            columns: []
          },
          axis: {
            x: {
              type: 'timeseries',
              tick: {
                format: '%Y-%m-%d'
              }
            },
            y: {
              label: {
                text: 'Usage (GB)',
                position: 'outer-middle'
              }
            }
          }
        });
        loadData(usage);
        $('#selection-menu').show();
        $('#filter-menu').show();
      });
    });
    $('#on-peak-download').click(function() {
      if (this.checked) {
        chart.show('On Peak Download');
      } else {
        chart.hide('On Peak Download');
      }
    });
    $('#on-peak-upload').click(function() {
      if (this.checked) {
        chart.show('On Peak Upload');
      } else {
        chart.hide('On Peak Upload');
      }
    });
    $('#off-peak-download').click(function() {
      if (this.checked) {
        chart.show('Off Peak Download');
      } else {
        chart.hide('Off Peak Download');
      }
    });
    $('#off-peak-upload').click(function() {
      if (this.checked) {
        chart.show('Off Peak Upload');
      } else {
        chart.hide('Off Peak Upload');
      }
    });
    $('#start-date-filter-enabled').click(function() {
      if (this.checked) {
        $('#start-date-filter').removeAttr('disabled');
      } else {
        $('#start-date-filter').attr('disabled', 'disabled');
      }
    });
    $('#end-date-filter-enabled').click(function() {
      if (this.checked) {
        $('#end-date-filter').removeAttr('disabled');
      } else {
        $('#end-date-filter').attr('disabled', 'disabled');
      }
    });
    $('#start-date-filter, #end-date-filter').change(function() {

      var startDate = $('#start-date-filter').val();
      var endDate = $('#end-date-filter').val();

      if (startDate) {
        startDate = moment(startDate);
      }
      if (endDate) {
        endDate = moment(endDate);
      }

      var filteredUsage = _.filter(usage, function(us) {
        var usDate = moment(us.Date);
        if (startDate && usDate < startDate) {
          return false;
        } else if (endDate && usDate > endDate) {
          return false;
        } else {
          return true;
        }
      });
      loadData(filteredUsage);
    });
   });
</script>
<style>
#selection-menu {
  display: none;
  float: left;
}
#filter-menu {
  display:none;
  float: left;
  padding-left: 50px;
}
</style>
 </head>
<body>
<div>
API Key <input type="text" id="api-key" value="8C2A92AA9A08B06EFD9A6CCEB37D7606"></input> <input type="button" value="Submit" id="submit"></input>
</div>
<div id="chart"></div>
<div id="selection-menu">
  <input type="checkbox" id="on-peak-download" checked="true">On Peak Download</input><br />
  <input type="checkbox" id="on-peak-upload" checked="true">On Peak Upload</input><br />
  <input type="checkbox" id="off-peak-download" checked="true">Off Peak Download</input><br />
  <input type="checkbox" id="off-peak-upload" checked="true">Off Peak Upload</input><br />
</div>
<div id="filter-menu">
<input type="checkbox" id="start-date-filter-enabled">Start</input> <input type="date" id="start-date-filter" disabled="disabled"></input><br />
<input type="checkbox" id="end-date-filter-enabled">End&nbsp;</input> <input type="date" id="end-date-filter" disabled="disabled"></input><br />
</div>
</body>
</html>
